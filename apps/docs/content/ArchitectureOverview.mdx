# Architecture Overview

AIA is a microservices-based system built around a **webhook-first** incident detection model. When a deployment fails on Vercel or GitHub Pages, a webhook fires instantly â€” no polling required.

## System Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          VERCEL / GITHUB PAGES DEPLOYMENT                  â”‚
â”‚                  (User's Application)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚  Deployment fails â†’ webhook fires
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          NEXT.JS WEB APP  (apps/web â€” Port 3006)           â”‚
â”‚   Webhook handlers: /api/webhooks/vercel                   â”‚
â”‚                     /api/webhooks/github                   â”‚
â”‚                                                            â”‚
â”‚   Dashboard pages: /incidents  /timeline  /chat            â”‚
â”‚   API routes:      /api/incidents  /api/projects           â”‚
â”‚   Integrations:    /api/foxit  /api/kilo  /api/cline       â”‚
â”‚                    /api/miro   /api/voice  /api/chat        â”‚
â”‚   Export:          /api/export (PDF)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚  Creates incident + triggers analysis
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STATE SERVICE  (apps/state â€” Port 3003)           â”‚
â”‚  â€¢ PostgreSQL via Prisma ORM                               â”‚
â”‚  â€¢ Stores incidents, autopsy results, projects             â”‚
â”‚  â€¢ REST API for all CRUD operations                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          AUTOPSY SERVICE  (apps/autopsy â€” Port 3002)       â”‚
â”‚  â€¢ AI analysis using You.com API                           â”‚
â”‚  â€¢ Generates: root cause, patch, fix prompt, manual steps  â”‚
â”‚  â€¢ Stores results back to State service                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                      â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AUTO PR     â”‚                    â”‚   MANUAL FIX MODE    â”‚
â”‚  â€¢ New branch â”‚                   â”‚   â€¢ Root cause card  â”‚
â”‚  â€¢ Git patch  â”‚                   â”‚   â€¢ AI fix prompt    â”‚
â”‚  â€¢ GitHub PR  â”‚                   â”‚   â€¢ Manual steps     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                 â”‚                    â”‚
           â–¼                                 â–¼                    â–¼
  âš¡ Fix with Kilo              ğŸ–¥ Cline Pipeline         ğŸ¦Š Foxit PDF
  (VS Code + Kilo AI)          (Auto fix agent)          (PDF Report)
                                                                  â”‚
                                                         ğŸ“‹ Miro Board
```

## Core Services

### Web App (Port 3006)

The **Next.js 14** app handles all user-facing functionality:

- **Webhook receivers** â€” `POST /api/webhooks/vercel` and `POST /api/webhooks/github`
- **Dashboard pages** â€” Project management, incident cards, timeline, chat
- **Integration APIs** â€” Foxit report, Kilo prompt, Cline pipeline, Miro board, voice commands
- **Authentication** â€” Clerk session management via middleware

### State Service (Port 3003)

**Purpose:** Single source of truth for all persistent data.

- PostgreSQL database via Prisma ORM
- Stores: projects, incidents, autopsy results
- REST API consumed by Web App and Autopsy service

Key tables:
| Table | Description |
| :--- | :--- |
| `Project` | GitHub repos linked by users |
| `Incident` | Detected deployment failures |
| `AutopsyResult` | AI analysis output |

### Autopsy Service (Port 3002)

**Purpose:** AI-powered root cause analysis.

- Called after each incident is created
- Queries You.com AI with the error context
- Returns: root cause text, patch diff, fix prompt, manual steps, confidence score
- Results persisted to State service

### Router Service (Port 3001)

**Purpose:** Incident enrichment and orchestration.

- Enriches incidents with code context from GitHub
- Coordinates the Autopsy trigger workflow
- Applies deduplication logic

### Agent Service (Port 4318)

**Purpose:** OpenTelemetry receiver (optional path).

- Accepts OTEL traces from instrumented applications
- Alternative to webhook-based detection (for server-side errors)
- Forwards detected errors to the routing pipeline

## Communication Model

All services communicate via **HTTP REST** over internal URLs:

```
Web App â†’ State    : http://localhost:3003
Web App â†’ Autopsy  : http://localhost:3002
Web App â†’ Router   : http://localhost:3001
Autopsy â†’ State    : http://localhost:3003
```

In production these are environment variables (`STATE_SERVICE_URL`, `AUTOPSY_SERVICE_URL`, etc.) pointing to deployed service URLs.

## Detection Paths

AIA supports two parallel incident detection paths:

| Path | Trigger | Use Case |
| :--- | :--- | :--- |
| **Webhook** | Vercel/GitHub sends HTTP event | Deployment failures (CI/CD) |
| **OpenTelemetry** | App emits OTEL traces | Runtime errors in running apps |

Both paths create the same `Incident` record and flow through Autopsy.

## Data Storage

| Store | Technology | Purpose |
| :--- | :--- | :--- |
| **Primary DB** | PostgreSQL (Neon) | Incidents, projects, autopsy results |
| **Object Storage** | Cloudflare R2 / S3 | Incident snapshots, patch files |

## Deployment Architecture

In production, AIA uses a **hybrid free-tier** deployment:

| Component | Platform | Notes |
| :--- | :--- | :--- |
| Web App | Vercel | Serverless Next.js |
| State Service | Render | Free-tier container |
| Autopsy Service | Render | Free-tier container |
| Router Service | Render | Free-tier container |
| Database | Neon | Serverless Postgres |
| Storage | Cloudflare R2 | S3-compatible |
| Auth | Clerk | Managed auth |

## Next Steps

- [Data Flow](/docs/architecture/data-flow) â€” Step-by-step data movement
- [AI Engine](/docs/architecture/ai-engine) â€” How Autopsy analysis works
- [Webhook Setup](/docs/webhooks) â€” Configure deployment monitoring
- [Configuration Reference](/docs/reference/config) â€” All config options
