# State Schema

The `Incident` object represents the lifecycle of a detected failure. It is managed by the State Service and stored in the database.

## Incident Lifecycle

An incident moves through the following statuses (`IncidentStatus`):

1.  **`detected`**: The anomaly has been ingested by the Router.
2.  **`analyzing`**: Autopsy is currently investigating the root cause.
3.  **`patching`**: The Agent is generating a fix.
4.  **`validating`**: Repro is running tests against the patch.
5.  **`resolved`**: A PR has been opened.
6.  **`failed`**: The agent could not resolve the issue.

## Incident Object

```typescript
interface Incident {
  id: string; // Unique UUID
  status: "detected" | "analyzing" | "patching" | "validating" | "resolved" | "failed";
  title: string;
  created_at: string; // ISO Date
  updated_at: string; // ISO Date

  // Artifact links
  snapshot_id?: string;     // ID of the OTel trace
  root_cause?: string;      // Markdown summary of the cause
  patch_diff_key?: string;  // R2 key for the .diff file
  pr_url?: string;          // GitHub PR link
  validation_status?: boolean;

  // Metadata
  repo_name?: string;
  file_path?: string; // The culprit file
}
```

## API Requests

### Create Incident

Used by the Router to register a new detection.

```json
{
  "title": "TypeError in /api/users",
  "status": "detected"
}
```

### Update Incident

Used by the Agent to progress the state.

```json
{
  "status": "resolved",
  "pr_url": "https://github.com/my-org/my-repo/pull/123",
  "validation_status": true
}
```
