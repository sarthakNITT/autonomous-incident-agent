# Repro Pipeline

The Repro (Reproduction) Pipeline is the validation layer of AIA. It ensures that every generated patch fixes the issue it claims to without breaking existing functionality.

## Test-Driven Repair

AIA follows a strict TDD approach to autonomous coding:

1.  **Fail**: Create a test case (`repro.ts`) that fails against the current codebase.
2.  **Fix**: Apply the patch.
3.  **Pass**: Verify the test case now passes.

## The `Repro Service`

The service runs in a sandboxed environment (e.g., a Docker container or isolated process).

### Workflow

1.  **Setup**: Clone the repo and checkout the specific commit where the error occurred.
2.  **Instrument**: Inject the generated `repro.ts` into the test suite.
3.  **Run (Red)**: Execute `bun test repro.ts`. It *must* fail. If it passes, the reproduction is invalid (hallucinated).
4.  **Patch**: Apply `fix.diff`.
5.  **Run (Green)**: Execute `bun test repro.ts`. It *must* pass.

## Manual Triggering

You can manually trigger a reproduction run for debugging purposes via HTTP:

<Tabs defaultValue="bash">
  <TabsList>
    <div className="flex items-center rounded-[4px] bg-[#18181b] p-0.5 border border-zinc-800/50">
      <TabsTrigger value="bash">bash</TabsTrigger>
    </div>
    <TabsCopyButton />
  </TabsList>
  <TabsContent value="bash">
    ```bash
    curl -X POST http://localhost:3005/reproduce \
      -H "Content-Type: application/json" \
      -d '{
        "repo": "my-org/my-repo",
        "commit": "sha123",
        "repro_script": "test(\"should fail\", () => { ... })"
      }'
    ```
  </TabsContent>
</Tabs>

## Anatomy of a `repro.ts`

A reproduction script is a standalone test file that mimics the conditions of the detected error.

```typescript
import { mainHandler } from "./src/main";

test("reproduce null pointer in mainHandler", async () => {
  const badInput = { user: null };
  // Expect this to throw
  expect(async () => await mainHandler(badInput)).toThrow();
});
```
