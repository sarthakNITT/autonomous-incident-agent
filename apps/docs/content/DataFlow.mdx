# Data Flow

This document details the lifecycle of an incident within AIA, tracing the path from a raw error to a resolved Pull Request.

## The Incident Lifecycle

The flow is strictly sequential but asynchronous, driven by the Agent's state machine.

### 1. Ingestion (Router)
*   **Input**: An HTTP POST with OpenTelemetry traces.
*   **Process**: The Router validates the trace, extracts the exception stack, and hashes it to create a unique `IncidentID`.
*   **Output**: An `IncidentDetected` event emitted to the internal bus.

### 2. Triage & Analysis (Agent & Autopsy)
*   **Input**: The `IncidentDetected` event.
*   **Process**:
    1.  The Agent assigns the incident to the **Autopsy** service.
    2.  Autopsy pulls the relevant source code from the **Git Service**.
    3.  It uses an LLM to analyze the code against the stack trace.
*   **Output**: An `AutopsyReport` containing the Root Cause Analysis (RCA) and a proposed fix plan.

### 3. Reproduction (Repro Service)
*   **Input**: The `AutopsyReport`.
*   **Process**:
    1.  The **Repro Service** spins up an isolated environment (e.g., a temporary directory or container).
    2.  It generates a *reproduction script* (a small test case) that triggers the bug.
    3.  It runs the script to confirm the failure (Red state).
*   **Output**: A `ReproResult` confirming the bug exists and is reproducible.

### 4. Remediation (Agent)
*   **Input**: A confirmed `ReproResult`.
*   **Process**:
    1.  The Agent requests a code patch from the LLM based on the Autopsy findings.
    2.  The patch is applied to the isolated environment.
    3.  The reproduction script is run again.
    4.  If the script passes (Green state) *and* existing tests pass, the patch is verified.
*   **Output**: A `VerifiedPatch` artifact.

### 5. Delivery (Git Service)
*   **Input**: The `VerifiedPatch`.
*   **Process**:
    1.  The **Git Service** checks out a new branch: `aia/fix-<incident-id>`.
    2.  It commits the patch and the reproduction test case.
    3.  It pushes the branch to GitHub.
    4.  It calls the GitHub API to open a Pull Request with a detailed description.
*   **Output**: A URL to the created Pull Request.
